!function(global){function is_true(a){return!!a&&(!(a instanceof Array)||a.length>0)}function isWhiteSpace(a){return!/\S/.test(a)}function Scanner(a){this.source=a,this.position=0,this.length=a.length}var _,regex_trim,regex_for,regex_with,escapeMap,_cache,space_map,_compiler,surge=global.surge={};surge.version="0.2.2 Alpha",surge.debug=!0,_=surge.__builtins={},surge.register=function(a,b){if(/^[_a-zA-Z]\w*/.test(a))return this.__builtins[a]=b,this;throw'"'+a+'" is not valid filter name.'},regex_trim=/^\s+|\s+$/g,regex_for=/(\w+)\s+in\s+(.*)/,regex_with=/((?:\w+)\s*=\s*(?:[\w\.]+))+/g,escapeMap={"<":"&lt;",">":"&gt;",'"':"&#39;","'":"&quot;","&":"&amp;"},String.prototype.hasOwnProperty("trim")||(String.prototype.trim=function(){return this.replace(regex_trim,"")}),surge.is_true=is_true,surge.register("trim",function(a){return"string"==typeof a?a.trim():a}).register("ltrim",function(a){return"string"==typeof a?a.replace(/^\s+/,""):a}).register("rtrim",function(a){return"string"==typeof a?a.replace(/\s+$/,""):a}).register("add",function(a){var b,c;if("number"==typeof a&&arguments.length>1){for(b=a,c=1;c<arguments.length;c++)b+=parseFloat(arguments[c]);return b}return a}).register("addslashes",function(a){return"string"==typeof a?a.replace(/(\'|\")/g,"\\$1"):a}).register("capfirst",function(a){return"string"==typeof a?a.replace(/^([a-z])/,function(a){return a.toUpperCase()}):a}).register("cut",function(a,b){return"string"==typeof a&&b?a.replace(new RegExp(b,"g"),""):a}).register("default",function(a,b){return is_true(a)?a:b}).register("sort",function(a,b){var c,d;if(a instanceof Array&&a.length>0){if("undefined"==typeof b){if("string"==typeof a[0])return a.sort();if("number"==typeof a[0]||"boolean"==typeof a[0])return a.sort(function(a,b){return a-b});for(c in a[0]){b=c;break}if("undefined"==typeof b)return a}if(a[0].hasOwnProperty(b))return d=function(a){return function(b,c){var d,e;if("object"==typeof b&&"object"==typeof c&&b&&c)return d=b[a],e=c[a],d===e?0:typeof d==typeof e?e>d?-1:1:typeof e>typeof d?-1:1;throw"error"}},a.sort(d(b))}return a}).register("reverse",function(a,b){return surge.__builtins.sort(a,b).reverse()}).register("escape",function(a){return a.replace(/[<>'"]|&(?!amp;)/g,function(a){return escapeMap[a]})}).register("length",function(a){return"string"==typeof a||a instanceof Array?a.length:a}).register("lower",function(a){return"string"==typeof a?a.toLowerCase():a}).register("upper",function(a){return"string"==typeof a?a.toUpperCase():a}).register("striptags",function(a){return"string"==typeof a?a.replace(/<(?:.|\s)*?>/g,""):a}).register("title",function(a){return"string"==typeof a?a.replace(/\B(\w*)/g,function(a){return a.toLowerCase()}).replace(/\b(\w)|\b(\w)/g,function(a){return a.toUpperCase()}):a}),Scanner.prototype.eos=function(){return this.position>=this.length},Scanner.prototype.skipWhiteSpace=function(){if(!(this.position>=this.length))for(var a=this.source.charAt(this.position);this.position<this.length&&isWhiteSpace(a);)this.position+=1,a=this.source.charAt(this.position)},Scanner.prototype.pop=function(){return this.source.charAt(this.position++)},Scanner.prototype.back=function(a){this.position-=0==arguments.length?1:a},Scanner.prototype.skipTo=function(a){var b=this.source.substring(this.position),c=a.length,d=b.indexOf(a);return d>-1?(this.position+=d+c,this.position):(this.position=this.length,-1)},Scanner.prototype.copy=function(a,b){return this.source.substring(a,b)},Scanner.prototype.readWord=function(){for(var a=this.position,b=this.source.charAt(this.position++);!this.eos()&&!isWhiteSpace(b);)b=this.source.charAt(this.position++);return this.source.substring(a,this.position-1)},_cache={},space_map={9:"\\t",13:"\\r",10:"\\n"},_compiler={get:function(a){var b,c,d;return _cache.hasOwnProperty(a)?b=_cache[a]:"document"in global&&(c=document.getElementById(a),c&&(d=c.value||c.innerHTML,b=_compiler.compile(d.trim()),_cache[a]=b)),b},parse_filter:function(a){var c,d,e,f,g,b=a.lastIndexOf("|");return b>0?(c=a.substr(0,b),d=a.substr(b+1),e=_compiler.parse_filter(c),f=d.split(":"),g="_."+f[0].trim(),f.length>1?g+"("+e+","+f[1].trim()+")":g+"("+e+")"):a.trim()},compile:function(source){var c,c2,c3,pos,pos2,codes,var_index,var_name,tag_stack,if_nested_stack,if_tags,if_tag_deep,token,v,word,parts,cs,i,p,exp_tag,stmpt,scanner=new Scanner(source);for(scanner.skipWhiteSpace(),codes=[],codes.push("function(context) {with(context){"),codes.push("var _html = [];"),var_index=1,tag_stack=[],if_nested_stack=[],if_tags=[],if_tag_deep=0,pos2=scanner.position;!scanner.eos();)switch(pos=scanner.position,c=scanner.pop()){case"{":if(!scanner.eos())if(pos>pos2&&codes.push('_html.push("'+scanner.copy(pos2,pos).replace(/("|')/g,"\\$1").replace(/(\t|\r|\n)/g,function(a){return space_map[a.charCodeAt()]})+'");'),pos2=scanner.position,c2=scanner.pop(),"{"===c2){if(c3=scanner.pop(),"{"!=c3){if(pos=scanner.position,pos2=scanner.skipTo("}}"),-1==pos2)throw'Syntax Error, "}}" is required.';token=scanner.copy(pos-1,pos2-2).trim(),v=_compiler.parse_filter(token),codes.push("try { _html.push("+v+"); } catch(e){}")}}else if("%"===c2){if(scanner.skipWhiteSpace(),word=scanner.readWord(),scanner.skipWhiteSpace(),pos=scanner.position,pos2=scanner.skipTo("%}"),pos2>-1)if(token=scanner.copy(pos,pos2-2).trim(),"if"==word||"elif"==word){for(parts=token.split(/\s*(and|or|\(|\))\s*/g),cs=[],i=0;i<parts.length;i++)p=parts[i],/and|or|\(|\)/.test(p)?"and"==p?cs.push("&&"):"or"==p?cs.push("||"):cs.push(p):(v=_compiler.parse_filter(token),cs.push("is_true("+v+")"));"if"==word?(tag_stack.push("if"),codes.push("if("+cs.join()+"){")):codes.push("} else if("+cs.join()+"){")}else if("else"==word)codes.push("} else {");else if("endfor"==word||"endif"==word||"endwith"==word){if(exp_tag=tag_stack.pop(),word!="end"+exp_tag)throw"Syntax Error, Block tag "+exp_tag+" required end"+exp_tag+" as endtag sign.";codes.push("}")}else if("for"==word){if(tag_stack.push("for"),var_name="$var_"+var_index++,!regex_for.test(token))throw'Syntax error for "for" expression.';v=_compiler.parse_filter(RegExp.$2),stmpt="var "+var_name+"="+v+";",stmpt+="for(var i=0;i<"+var_name+".length;i++){var "+RegExp.$1+"="+var_name+"[i];",codes.push(stmpt)}else if("with"==word)for(tag_stack.push("with"),parts=token.match(regex_with),codes.push("{"),i=0;i<parts.length;i++)codes.push("var "+parts[i]+";")}else"#"===c2?pos2=scanner.skipTo("#}"):codes.push('_html.push("'+scanner.copy(pos,pos2).replace(/("|')/g,"\\$1")+'");')}if(pos>pos2&&codes.push('_html.push("'+scanner.copy(pos2,pos+1).replace(/("|')/g,"\\$1")+'");'),tag_stack.length>0)throw'Syntax Error, "'+tag_stack.join()+'" need endtag signed.';return codes.push('} return _html.join(""); }'),console.log(codes.join("")),{render:eval("("+codes.join("")+")")}}},surge.compile=_compiler.compile,surge.get_template=_compiler.get}(this);