!function(t){var e="object"==typeof self&&self.self==self&&self||"object"==typeof global&&global.global==global&&global;"function"==typeof define&&define.amd?define(["exports"],function(r){e.surge=t(e,r)}):"undefined"!=typeof exports?t(e,exports):t(e,{})}(function(t,e){function r(t){return!!t&&(!(t instanceof Array)||t.length>0)}function n(t){return regex_number.test(t[0])||regex_const_string.test(t)}function i(t){return!/\S/.test(t)}function o(t){this.source=t,this.position=0,this.length=t.length}function s(t){return t.replace(/("|')/g,"\\$1").replace(/(\t|\r|\n)/g,function(t){return g[t.charCodeAt()]})}t.surge=e,e.version="0.2.4 Alpha",e.debug=!0;e.__builtins={};e.register=function(t,e){if(/^[_a-zA-Z]\w*/.test(t))return this.__builtins[t]=e,this;throw'"'+t+'" is not valid filter name.'};var p=/^\s+|\s+$/g,u=/(\w+)\s+in\s+(.*)/,f=/((?:\w+)\s*=\s*(?:[\w\.]+))+/g;regex_number=/[-+\.\d]/,regex_const_string=/^(['"]).*\1$/;var a={"<":"&lt;",">":"&gt;",'"':"&#39;","'":"&quot;","&":"&amp;"};String.prototype.hasOwnProperty("trim")||(String.prototype.trim=function(){return this.replace(p,"")}),e.is_true=r,e.register("trim",function(t){return"string"==typeof t?t.trim():t}).register("ltrim",function(t){return"string"==typeof t?t.replace(/^\s+/,""):t}).register("rtrim",function(t){return"string"==typeof t?t.replace(/\s+$/,""):t}).register("add",function(t){if("number"==typeof t&&arguments.length>1){for(var e=t,r=1;r<arguments.length;r++)e+=parseFloat(arguments[r]);return e}return t}).register("capfirst",function(t){return"string"==typeof t?t.replace(/^([a-z])/,function(t){return t.toUpperCase()}):t}).register("cut",function(t,e){return"string"==typeof t&&e?t.replace(new RegExp(e,"g"),""):t}).register("default",function(t,e){return r(t)?t:e}).register("sort",function(t,e){if(t instanceof Array&&t.length>0){if("undefined"==typeof e){if("string"==typeof t[0])return t.sort();if("number"==typeof t[0]||"boolean"==typeof t[0])return t.sort(function(t,e){return t-e});for(var r in t[0]){e=r;break}if("undefined"==typeof e)return t}if(t[0].hasOwnProperty(e)){var n=function(t){return function(e,r){var n,i;if("object"==typeof e&&"object"==typeof r&&e&&r)return n=e[t],i=r[t],n===i?0:typeof n==typeof i?i>n?-1:1:typeof i>typeof n?-1:1;throw"error"}};return t.sort(n(e))}}return t}).register("reverse",function(t,r){return e.__builtins.sort(t,r).reverse()}).register("escape",function(t){return t.replace(/[<>'"]|&(?!amp;)/g,function(t){return a[t]})}).register("length",function(t){return"string"==typeof t||t instanceof Array?t.length:t}).register("lower",function(t){return"string"==typeof t?t.toLowerCase():t}).register("upper",function(t){return"string"==typeof t?t.toUpperCase():t}).register("striptags",function(t){return"string"==typeof t?t.replace(/<(?:.|\s)*?>/g,""):t}).register("title",function(t){return"string"==typeof t?t.replace(/\B(\w*)/g,function(t){return t.toLowerCase()}).replace(/\b(\w)|\b(\w)/g,function(t){return t.toUpperCase()}):t}).register("truncate",function(t,e){return"string"==typeof t&&t.length>e?t.substring(0,e-3)+"...":t}),o.prototype.eos=function(){return this.position>=this.length},o.prototype.skipWhiteSpace=function(){if(!(this.position>=this.length))for(var t=this.source.charAt(this.position);this.position<this.length&&i(t);)this.position+=1,t=this.source.charAt(this.position)},o.prototype.pop=function(){return this.source.charAt(this.position++)},o.prototype.back=function(t){0===arguments.length?this.position-=1:this.position-=t},o.prototype.skipTo=function(t){var e=this.source.substring(this.position),r=t.length,n=e.indexOf(t);return n>-1?(this.position+=n+r,this.position):(this.position=this.length,-1)},o.prototype.copy=function(t,e){return this.source.substring(t,e)},o.prototype.readWord=function(){for(var t=this.position,e=this.source.charAt(this.position++);!this.eos()&&!i(e);)e=this.source.charAt(this.position++);return this.source.substring(t,this.position-1)};var c={},g={9:"\\t",13:"\\r",10:"\\n"};e.get_template=function(t){var r;if(c.hasOwnProperty(t))r=c[t];else if("document"in global){var n=document.getElementById(t);if(n){var i=n.value||n.innerHTML;r=e.compile(i.trim()),c[t]=r}}return r},e.compile=function(t){function e(t){return-1!==S.indexOf(t)}function r(t){var i=t.lastIndexOf("|");if(i>0){var o=t.substr(0,i),s=t.substr(i+1),p=r(o),u=s.split(":"),f="_."+u[0].trim();return u.length>1?f+"("+p+","+u[1].trim()+")":f+"("+p+")"}return t=t.trim(),n(t)||e(t.split(".")[0])?t:"context."+t}var i=new o(t);i.skipWhiteSpace();var p,a,c,g,h,l="";l+='var _html = "";var _ = surge.__builtins;';var y,d,v,m,b,_,w,x,k=1,A=[],S=[];for(h=i.position;!i.eos();)switch(g=i.position,p=i.pop()){case"{":if(!i.eos())if(g>h&&(l+='_html+="'+s(i.copy(h,g))+'";'),h=i.position,a=i.pop(),"{"===a){if(c=i.pop(),"{"!=c){if(g=i.position,h=i.skipTo("}}"),-1==h)throw'Syntax Error, "}}" is required.';b=i.copy(g-1,h-2).trim(),m=r(b),l+="_html+="+m+";"}}else if("%"===a){i.skipWhiteSpace();var $=i.readWord();if(i.skipWhiteSpace(),g=i.position,h=i.skipTo("%}"),h>-1)if(b=i.copy(g,h-2).trim(),"if"==$||"elif"==$){_=b.split(/\s*(and|or|\(|\))\s*/g);var E=[];for(x=0;x<_.length;x++){var j=_[x];if(n(j))E.push(j);else if(/and|or|\(|\)/.test(j))"and"==j?E.push("&&"):"or"==j?E.push("||"):E.push(j);else if(w=j.split(/(==|>=|<=|<|>)/),m="",w.length>1){m="(";for(var C=0;C<w.length;C++){var O=w[C];m+=n(O)||/==|>=|<=|<|>/.test(O)?O:r(O)}m+=")",E.push(m)}else m=r(j),E.push("surge.is_true("+m+")")}"if"==$?(A.push("if"),l+="if("+E.join("")+"){"):l+="} else if("+E.join("")+"){"}else if("else"==$)l+="} else {";else if("endfor"==$||"endif"==$||"endwith"==$){var W=A.pop();if($!=="end"+W)throw"Syntax Error, Block tag "+W+" required end"+W+" as endtag sign.";l+="}",("endfor"===$||"endwith"===$)&&S.pop()}else if("for"==$){if(A.push("for"),y="$var_"+k++,d="$loop_var1"+k,v="$loop_var2"+k,!u.test(b))throw'Syntax error for "for" expression.';m=r(RegExp.$2);var T="var "+y+"="+m+";";T+="for(var "+d+"=0,"+v+"="+y+".length;"+d+"<"+v+";"+d+"++){var "+RegExp.$1+"="+y+"["+d+"];",S.push(RegExp.$1),l+=T}else if("with"==$)for(A.push("with"),_=b.match(f),l+="{",x=0;x<_.length;x++){w=_[x].split("=");var R=w[0].trim(),q=r(w[1].trim());l+="var "+R+"="+q+";",S.push(R)}}else"#"===a?h=i.skipTo("#}"):l+='_html+="'+s(i.copy(g,h))+'";'}if(g>h&&(l+='_html += "'+s(i.copy(h,g+1))+'";'),A.length>0)throw'Syntax Error, "'+A.join()+'" need endtag signed.';return l+=" return _html;",{render:new Function("context",l)}}});